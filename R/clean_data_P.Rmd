
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = F, message = F,
                      root.dir = '.')
```

```{r libraries}
library("tidyverse")
```


```{r}
getwd()
```

```{r load data}
setwd("../data/_raw")
metadata_raw = read_csv(file = "clinical_data_breast_cancer.csv")
proteome_raw = read_csv(file = "77_cancer_proteomes_CPTAC_itraq.csv")
```


# Metadata raw: 
* 105 rows --> patients
* 77 "valid" patients + 28 patients that did not pass QC
* 30 cols --> ID + 29 clinical features

```{r}
metadata_raw
```

# Proteome raw:
* 12553 rows --> proteins
* 86 cols --> accesion number + gene symbol + gene name + 83 log2 iTRAQ ratios
* 83 log2 iTRAQ ratios --> 80 patients + 3 healthy
* 80 patients --> 77 real patients + 3 replicates 

```{r}
proteome_raw
```

# Clean metadata

Only change ID names (column ID) to simpler ones
```{r clean metadata}
metadata <- metadata_raw %>% 
  mutate(ID = gsub("TCGA-", "", `Complete TCGA ID`)) %>% 
  select(-`Complete TCGA ID`) %>% # change name of patients' ID
  select(ID, everything())        # put ID column in first position
```

result = 105 rows x 30 cols (patient ID + 29 clinical features)
```{r}
metadata
```

# Clean proteome

*Remove gene columns (save it in other file), only keep protein IDs
*Remove three healthy patients
*Remove three replicates
*Change patient ID names (column names) to simpler ones
```{r clean proteome}
proteome <- proteome_raw %>% 
  # remove gene info
  select(-gene_symbol, -gene_name) %>%  

  # remove healthy patients 
  select(-c(ends_with("CPTAC")))

# identify replicates
replicates <- colnames(proteome) %>% 
  str_replace_all(., '\\...TCGA', '') %>% 
  sort() %>%  
  duplicated()
cols_proteome <- colnames(proteome) %>% 
  sort()

 # remove replicates
proteome <- proteome %>% 
  select (-cols_proteome[replicates]) %>% 
  # change ID patients
  rename_all(funs(stringr::str_replace_all(., '\\...TCGA', '')))
```

result = 12553 rows * 78 cols (prot ID + 77 patients)
```{r}
proteome
```


```{r keep protein-gene data}
protein_data <- proteome_raw %>% 
  select(RefSeq_accession_number, gene_symbol, gene_name)
```

Some text from the paper that confirms the number of samples is correct:
"Of the 105 tumor samples and 3 normal breast tissues analyzed, 77 tumors,
as well as replicates of 3 of the tumor samples and the 3 normal samples, exhibited the
expected Gaussian distribution. However, 28 of the tumor samples exhibited highly
skewed protein distributions caused by very low abundance or complete absence of
thousands of proteins (Extended Data Fig. 2c)".


# Transpose proteome
```{r transpose}
proteome_transposed <- proteome %>%
    gather(ID, value, -RefSeq_accession_number) %>% 
    spread(RefSeq_accession_number, value)
```


# Join two data sets
```{r join}
data <- inner_join(metadata, proteome_transposed, by="ID")
data
```
12583 cols -> ID + 29 clinical data + 12553 proteins
77 rows --> patients


Here I will check that patients that are in joined dataset are actually the same that were in proteomes dataset and not in 
```{r check}
sort(proteome_transposed$ID) == sort(data$ID)
```

Seems to work fine

Write files
```{r write}
setwd("../data")
save(data, file = "clean_data_P.RData")
save(protein_data, file = "protein_data_P.RData")
```

